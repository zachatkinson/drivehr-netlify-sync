openapi: 3.0.3
info:
  title: DriveHR Netlify Sync API
  description: |
    **Serverless job synchronization API for DriveHR integration**

    A secure, high-performance job synchronization service built on Netlify Functions that handles job data synchronization between DriveHR career portals and WordPress sites.

    ## Key Features
    - üîê **HMAC-SHA256 webhook security** with timing-safe validation
    - ‚ö° **Serverless architecture** with auto-scaling and global distribution  
    - üß™ **80%+ test coverage** ensuring reliability and correctness
    - üìä **Built-in monitoring** with health checks and telemetry
    - üõ°Ô∏è **Enterprise security** headers and input validation
    - üîÑ **Robust error handling** with comprehensive logging

    ## Authentication
    All webhook endpoints use HMAC-SHA256 signature validation. The `X-Webhook-Signature` header must contain a valid signature of the request body using the configured webhook secret.

    Format: `sha256=<hex_digest>`

    ## Base URLs
    - **Production**: `https://your-site.netlify.app/.netlify/functions`
    - **Development**: `http://localhost:8888/.netlify/functions`

  version: 2.0.0
  contact:
    name: DriveHR Sync Support
    url: https://github.com/zachatkinson/drivehr-netlify-sync
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://your-site.netlify.app/.netlify/functions
    description: Production Netlify Functions
  - url: http://localhost:8888/.netlify/functions
    description: Local Development Server

tags:
  - name: Health Monitoring
    description: System health and configuration validation
  - name: Job Synchronization
    description: Job data synchronization operations
  - name: Administrative
    description: Manual triggers and administrative functions

paths:
  /health-check:
    get:
      tags:
        - Health Monitoring
      summary: System health check
      description: |
        **Comprehensive system health monitoring**

        Validates all critical system components and external dependencies for production readiness.

        ### Health Checks Include:
        - Environment configuration validation
        - WordPress endpoint connectivity  
        - DriveHR portal accessibility
        - Service configuration integrity

        ### Response Codes:
        - **200**: All systems operational
        - **503**: One or more critical systems unavailable
        - **500**: Health check system failure

      operationId: healthCheck
      responses:
        '200':
          description: All systems healthy and operational
          headers:
            X-Health-Check-Duration:
              description: Health check execution time in milliseconds
              schema:
                type: integer
                example: 324
            Cache-Control:
              description: Response caching policy
              schema:
                type: string
                example: 'no-cache, must-revalidate'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                healthy:
                  summary: All systems healthy
                  value:
                    success: true
                    data:
                      status: 'healthy'
                      environment: 'production'
                      wordpress_configured: true
                      drivehr_configured: true
                      architecture: 'netlify-functions'
                      version: '2.0.0'
                    timestamp: '2025-01-21T12:00:00.000Z'
                    requestId: 'health_abc123def456'

        '503':
          description: Service degraded or dependencies unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Service degraded: WordPress endpoint unreachable'
                details:
                  component: 'wordpress'
                  status: 'timeout'
                  lastSuccess: '2025-01-21T11:30:00.000Z'
                timestamp: '2025-01-21T12:00:00.000Z'
                requestId: 'health_abc123def456'

        '500':
          $ref: '#/components/responses/InternalServerError'

  /sync-jobs:
    post:
      tags:
        - Job Synchronization
      summary: Synchronize job postings
      description: |
        **Primary job synchronization endpoint**

        Processes webhook requests to synchronize job postings from DriveHR to WordPress.

        ### Process Flow:
        1. Validate HMAC webhook signature for security
        2. Load and validate system configuration
        3. Fetch job data from DriveHR career portal
        4. Parse and normalize job data structures  
        5. Synchronize jobs with WordPress via webhook
        6. Return comprehensive sync results and statistics

        ### Security:
        - Requires valid HMAC-SHA256 signature
        - Input validation and sanitization
        - Rate limiting and abuse prevention

      operationId: syncJobs
      security:
        - WebhookSignature: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncJobsRequest'
            examples:
              manual:
                summary: Manual sync trigger
                value:
                  source: 'manual'
                  timestamp: '2025-01-21T12:00:00.000Z'
                  metadata:
                    reason: 'Content update requested'
                    userId: 'admin-123'
              webhook:
                summary: Webhook-triggered sync
                value:
                  source: 'webhook'
                  timestamp: '2025-01-21T12:00:00.000Z'
                  metadata:
                    trigger: 'scheduled'

      responses:
        '200':
          description: Job synchronization completed successfully
          headers:
            X-Sync-Duration:
              description: Total sync operation duration in milliseconds
              schema:
                type: integer
                example: 2847
            X-Jobs-Processed:
              description: Number of jobs processed in this sync
              schema:
                type: integer
                example: 45
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncSuccessResponse'
              examples:
                successful:
                  summary: Successful sync with changes
                  value:
                    success: true
                    data:
                      jobsProcessed: 45
                      jobsCreated: 12
                      jobsUpdated: 8
                      jobsRemoved: 3
                      syncDuration: 2847
                      source: 'manual'
                      wordpress_response: 'success'
                    timestamp: '2025-01-21T12:00:47.123Z'
                    requestId: 'sync_abc123def456'
                noChanges:
                  summary: Sync completed with no changes
                  value:
                    success: true
                    data:
                      jobsProcessed: 45
                      jobsCreated: 0
                      jobsUpdated: 0
                      jobsRemoved: 0
                      syncDuration: 1234
                      source: 'webhook'
                      wordpress_response: 'no_changes'
                    timestamp: '2025-01-21T12:00:47.123Z'
                    requestId: 'sync_def456ghi789'

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /manual-trigger:
    post:
      tags:
        - Administrative
      summary: Manual synchronization trigger
      description: |
        **Administrative manual job synchronization**

        Allows authorized systems to manually trigger job synchronization outside of normal operations.

        ### Use Cases:
        - Content updates requiring immediate sync
        - Testing and development workflows  
        - Recovery from failed operations
        - Administrative maintenance tasks

        ### Security:
        - Requires valid HMAC signature for authorization
        - All triggers logged for audit purposes
        - Request context captured for troubleshooting

      operationId: manualTrigger
      security:
        - WebhookSignature: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ManualTriggerRequest'
            examples:
              basic:
                summary: Basic manual trigger
                value:
                  force_sync: false
                  reason: 'Content update requested'
              force:
                summary: Force sync (bypass cache)
                value:
                  force_sync: true
                  reason: 'Data inconsistency detected'

      responses:
        '200':
          description: Manual trigger executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManualTriggerResponse'
              example:
                success: true
                data:
                  message: 'Manual sync triggered successfully'
                  force_sync: false
                  reason: 'Content update requested'
                timestamp: '2025-01-21T12:00:00.000Z'
                requestId: 'trigger_abc123def456'

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    WebhookSignature:
      type: apiKey
      in: header
      name: X-Webhook-Signature
      description: |
        HMAC-SHA256 signature of the request body using the configured webhook secret.

        **Format**: `sha256=<hex_digest>`

        **Example**: `sha256=a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1`

        **Generation**:
        ```javascript
        const signature = crypto
          .createHmac('sha256', webhookSecret)
          .update(JSON.stringify(payload))
          .digest('hex');
        const header = `sha256=${signature}`;
        ```

  schemas:
    HealthResponse:
      type: object
      required:
        - success
        - data
        - timestamp
        - requestId
      properties:
        success:
          type: boolean
          description: Indicates if health check passed
          example: true
        data:
          type: object
          required:
            - status
            - environment
            - wordpress_configured
            - drivehr_configured
            - architecture
          properties:
            status:
              type: string
              enum: [healthy, degraded, unhealthy]
              description: Overall system health status
              example: 'healthy'
            environment:
              type: string
              enum: [development, staging, production]
              description: Current deployment environment
              example: 'production'
            wordpress_configured:
              type: boolean
              description: WordPress endpoint configuration status
              example: true
            drivehr_configured:
              type: boolean
              description: DriveHR integration configuration status
              example: true
            architecture:
              type: string
              description: System architecture identifier
              example: 'netlify-functions'
            version:
              type: string
              description: Application version
              example: '2.0.0'
        timestamp:
          type: string
          format: date-time
          description: Health check execution timestamp
          example: '2025-01-21T12:00:00.000Z'
        requestId:
          type: string
          description: Unique request identifier for debugging
          example: 'health_abc123def456'

    SyncJobsRequest:
      type: object
      required:
        - source
        - timestamp
      properties:
        source:
          type: string
          enum: [manual, webhook, scheduled]
          description: Source of the sync request
          example: 'manual'
        timestamp:
          type: string
          format: date-time
          description: Request timestamp
          example: '2025-01-21T12:00:00.000Z'
        metadata:
          type: object
          description: Additional context for the sync operation
          additionalProperties: true
          example:
            reason: 'Content update requested'
            userId: 'admin-123'

    SyncSuccessResponse:
      type: object
      required:
        - success
        - data
        - timestamp
        - requestId
      properties:
        success:
          type: boolean
          description: Indicates successful sync completion
          example: true
        data:
          type: object
          required:
            - jobsProcessed
            - jobsCreated
            - jobsUpdated
            - jobsRemoved
            - syncDuration
            - source
            - wordpress_response
          properties:
            jobsProcessed:
              type: integer
              description: Total number of jobs processed
              example: 45
            jobsCreated:
              type: integer
              description: Number of new jobs created
              example: 12
            jobsUpdated:
              type: integer
              description: Number of existing jobs updated
              example: 8
            jobsRemoved:
              type: integer
              description: Number of jobs removed or expired
              example: 3
            syncDuration:
              type: integer
              description: Total sync duration in milliseconds
              example: 2847
            source:
              type: string
              enum: [manual, webhook, scheduled]
              description: Source of the sync request
              example: 'manual'
            wordpress_response:
              type: string
              enum: [success, no_changes, partial_failure]
              description: WordPress sync response status
              example: 'success'
        timestamp:
          type: string
          format: date-time
          description: Response generation timestamp
          example: '2025-01-21T12:00:47.123Z'
        requestId:
          type: string
          description: Unique request identifier for debugging
          example: 'sync_abc123def456'

    ManualTriggerRequest:
      type: object
      required:
        - force_sync
        - reason
      properties:
        force_sync:
          type: boolean
          description: Force sync bypassing cache and rate limits
          default: false
          example: false
        reason:
          type: string
          minLength: 10
          maxLength: 200
          description: Reason for manual trigger (for audit logging)
          example: 'Content update requested'

    ManualTriggerResponse:
      type: object
      required:
        - success
        - data
        - timestamp
        - requestId
      properties:
        success:
          type: boolean
          description: Indicates successful trigger execution
          example: true
        data:
          type: object
          required:
            - message
            - force_sync
            - reason
          properties:
            message:
              type: string
              description: Human-readable success message
              example: 'Manual sync triggered successfully'
            force_sync:
              type: boolean
              description: Whether force sync was requested
              example: false
            reason:
              type: string
              description: The provided reason for the trigger
              example: 'Content update requested'
        timestamp:
          type: string
          format: date-time
          description: Response generation timestamp
          example: '2025-01-21T12:00:00.000Z'
        requestId:
          type: string
          description: Unique request identifier for debugging
          example: 'trigger_abc123def456'

    ErrorResponse:
      type: object
      required:
        - success
        - error
        - timestamp
        - requestId
      properties:
        success:
          type: boolean
          description: Always false for error responses
          example: false
        error:
          type: string
          description: Human-readable error message
          example: 'Invalid webhook signature'
        details:
          type: object
          description: Additional error context and debugging information
          additionalProperties: true
          example:
            component: 'authentication'
            expected: 'Valid HMAC-SHA256 signature'
            provided: 'Missing signature header'
        timestamp:
          type: string
          format: date-time
          description: Error occurrence timestamp
          example: '2025-01-21T12:00:00.000Z'
        requestId:
          type: string
          description: Unique request identifier for debugging
          example: 'req_abc123def456'

  responses:
    BadRequest:
      description: Invalid request format or missing required fields
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: "Invalid request body: missing required field 'source'"
            details:
              field: 'source'
              expected: 'string'
              allowedValues: ['manual', 'webhook', 'scheduled']
            timestamp: '2025-01-21T12:00:00.000Z'
            requestId: 'req_abc123def456'

    Unauthorized:
      description: Missing or invalid webhook signature
      headers:
        WWW-Authenticate:
          description: Authentication scheme required
          schema:
            type: string
            example: 'Webhook signature required'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: 'Invalid webhook signature'
            details:
              expected: 'Valid HMAC-SHA256 signature in X-Webhook-Signature header'
              format: 'sha256=<hex_digest>'
            timestamp: '2025-01-21T12:00:00.000Z'
            requestId: 'req_abc123def456'

    InternalServerError:
      description: Internal server error or system failure
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: 'Internal server error occurred'
            details:
              component: 'job-fetcher'
              operation: 'fetch-jobs'
            timestamp: '2025-01-21T12:00:00.000Z'
            requestId: 'req_abc123def456'

    ServiceUnavailable:
      description: Service temporarily unavailable due to external dependencies
      headers:
        Retry-After:
          description: Seconds to wait before retrying
          schema:
            type: integer
            example: 300
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: 'Service temporarily unavailable: DriveHR portal unreachable'
            details:
              service: 'drivehr-portal'
              lastSuccess: '2025-01-21T11:30:00.000Z'
              retryAfter: 300
            timestamp: '2025-01-21T12:00:00.000Z'
            requestId: 'req_abc123def456'
